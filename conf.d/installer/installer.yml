name: OpenCity
version: 3.0.6
variables:
  - name: identifier
    value: 'OpenPABase::getCurrentSiteaccessIdentifier'
  - name: root_node
    value: 'ini(NodeSettings,RootNode,content.ini)'
  - name: media_root_node
    value: 'ini(NodeSettings,MediaRootNode,content.ini)'
  - name: anonymous_user
    value: 'ini(UserSettings,AnonymousUserID,site.ini)'
  - name: members
    value: 11
  - name: members_node
    value: 12
  - name: members_path_string
    value: /1/5/12/
  - name: users
    value: 5
  - name: recaptcha_public
    value: env(RECAPTCHA_PUBLIC)
  - name: recaptcha_private
    value: env(RECAPTCHA_PRIVATE)
  - name: recaptcha_v3_public
    value: env(RECAPTCHA_V3_PUBLIC)
  - name: recaptcha_v3_private
    value: env(RECAPTCHA_V3_PRIVATE)
  - name: section_standard
    value: 1
  - name: section_media
    value: 3
  - name: content_Files_node
    value: 52
  - name: content_Files_path_string
    value: /1/43/52/
  - name: content_Images_node
    value: 51
  - name: content_Images_path_string
    value: /1/43/51/
  - name: content_Multimedia_node
    value: 53
  - name: content_Multimedia_path_string
    value: /1/43/53/
  - name: check_eztags_sequence
    value: env(CHECK_EZTAGS_SEQUENCE)
  - name: update_comuni
    value: env(UPDATE_COMUNI)
  - name: do_lock
    value: false
  - name: reset
    value: false
steps:
  - type: sql
    identifier: alter_contentobject_date_interger_type

  - type: sql_copy_from_tsv
    identifier: eztags
    table: eztags
    condition: $is_install_from_scratch
  - type: sql_copy_from_tsv
    identifier: eztags_keyword
    table: eztags_keyword
    condition: $is_install_from_scratch
  - type: sql
    identifier: check_eztags_sequence
    condition: $is_install_from_scratch

  - type: states
    identifiers:
      - opencity_lock
      - moderation
      - privacy
      - albotelematico
      - concorso

  - type: sections
    identifiers:
      - intranet
      - restricted
      - oggetti_scaduti

  - type: tagtree_csv
    identifiers:
      - costi_e_prezzi
      - data_themes_eurovocs
      - dataset
      - documenti
      - esito_servizi_al_cittadino
      - eventi
      - licenze
      - lingue_in_cui_e_disponibile_un_servizio_un_evento
      - luoghi
      - organizzazione
      - parole_chiave_generali
      - persone
      - servizi_pubblici
      - tipi_di_notizia

  - type: sql_copy_from_tsv
    identifier: openpacomuniitaliani
    table: openpacomuniitaliani
    condition: $is_install_from_scratch

  - type: php_callable
    identifier: 'OpenPAComuniItaliani::import'
    condition: $update_comuni

  - type: class_with_extra
    identifier: folder
  - type: class_with_extra
    identifier: pagina_sito
  - type: class_with_extra
    identifier: frontpage
  - type: class_with_extra
    identifier: image
  - type: class_with_extra
    identifier: link

  - type: images_from_url
    urls:
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/Consiglio-comunale.jpg
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/Giunta-comunale.jpg
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/Il-nuovo-modello-di-sito-web-comunale.png
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/competenze-digitali.png
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/comuni-2022.png
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/kit_architettura.png
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/opencityitalia.png
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/sindaco.jpg
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/viale-alberato.jpg
      - https://s3-eu-west-1.amazonaws.com/static.opencity.opencontent.it/installer/digitale.jpg
    parent: $content_Images_node
    attributes:
      license:
        - "Licenza sconosciuta"
      author: "Autore sconosciuto"

  - type: contenttree
    identifier: OpenCity
    parent: $root_node
    lock: $do_lock
    reset:
      - name
      - abstract
      - show_children
      - layout
      - tag_menu
      - show_tag_cards
  - type: content
    identifier: Privacy
  - type: content
    identifier: Note-legali
  - type: contenttree
    identifier: Amministrazione
    parent: $contenttree_OpenCity_Amministrazione_node
    lock: $do_lock
    reset:
      - name
      - abstract
      - show_children
      - layout
      - tag_menu
      - show_tag_cards
  - type: contenttree
    identifier: Privacy
    parent: $content_Privacy_node
  - type: contenttree
    identifier: Novita
    parent: $contenttree_OpenCity_Novita_node
    lock: $do_lock
    reset:
      - name
      - abstract
      - show_children
      - layout
      - tag_menu
      - show_tag_cards
  - type: contenttree
    identifier: Vivere-il-comune
    parent: $contenttree_OpenCity_Vivere-il-comune_node
    lock: $do_lock
    reset:
      - name
      - abstract
      - show_children
      - layout
      - tag_menu
      - show_tag_cards
  - type: contenttree
    identifier: Documenti-e-dati
    parent: $contenttree_Amministrazione_Documenti-e-dati_node
    lock: $do_lock
    reset:
      - name
      - abstract
      - show_children
      - layout
      - tag_menu
      - show_tag_cards
  - type: contenttree
    identifier: Classificazioni
    parent: $contenttree_OpenCity_Classificazioni_node
    lock: $do_lock

  - type: class_with_extra
    identifier: topic
  - type: contenttree
    identifier: Argomenti
    parent: $contenttree_OpenCity_Argomenti_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Agricoltura-silvicoltura-e
    parent: $contenttree_Argomenti_Agricoltura-silvicoltura-e-pesca_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Ambiente
    parent: $contenttree_Argomenti_Ambiente_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Demografia-e-popolazione
    parent: $contenttree_Argomenti_Demografia-e-popolazione_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Diritto
    parent: $contenttree_Argomenti_Diritto_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Economia
    parent: $contenttree_Argomenti_Economia_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Energia
    parent: $contenttree_Argomenti_Energia_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Innovazione
    parent: $contenttree_Argomenti_Innovazione_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Istruzione
    parent: $contenttree_Argomenti_Istruzione_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Pianificazione-del-territorio
    parent: $contenttree_Argomenti_Pianificazione-del-territorio_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Politica
    parent: $contenttree_Argomenti_Politica_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Questioni-sociali
    parent: $contenttree_Argomenti_Questioni-sociali_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Relazioni-internazionali
    parent: $contenttree_Argomenti_Relazioni-internazionali_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Tempo-libero
    parent: $contenttree_Argomenti_Tempo-libero_node
    lock: $do_lock
    reset:
      - name
      - eu
      - data_themes_eurovocs
  - type: contenttree
    identifier: Argomenti-Trasporto-pubblico
    parent: $contenttree_Argomenti_Trasporto-pubblico_node

  - type: content
    identifier: Ruoli
  - type: content
    identifier: Banner
  - type: content
    identifier: Contenuti-obsoleti
  - type: content
    identifier: Dichiarazione-di-accessibilita

  - type: content
    identifier: Editor-Base
  - type: content
    identifier: Editor-Amministrazione
  - type: content
    identifier: Editor-Vivere-il-comune
  - type: content
    identifier: Editor-Novita
  - type: content
    identifier: Editor-Servizi
  - type: content
    identifier: Editor-Utenti
  - type: content
    identifier: Editor-Sito
    lock: true
  - type: content
    identifier: Editor-Homepage

  - type: class
    identifier: apps_container
  - type: class_with_extra
    identifier: user_group
  - type: class_with_extra
    identifier: user
    remove_extra: true
  - type: class_with_extra
    identifier: file
  - type: class_with_extra
    identifier: chart
  - type: class_with_extra
    identifier: banner
  - type: class_with_extra
    identifier: audio
  - type: class_with_extra
    identifier: channel
  - type: class_with_extra
    identifier: output
  - type: class_with_extra
    identifier: time_indexed_role
  - type: class_with_extra
    identifier: offer
  - type: class_with_extra
    identifier: article
  - type: class_with_extra
    identifier: public_person
  - type: class_with_extra
    identifier: organization
  - type: class_with_extra
    identifier: private_organization
  - type: class_with_extra
    identifier: event
  - type: class_with_extra
    identifier: public_service
  - type: class_with_extra
    identifier: document
  - type: class_with_extra
    identifier: place
  - type: class_with_extra
    identifier: online_contact_point
  - type: class_with_extra
    identifier: opening_hours_specification
  - type: class_with_extra
    identifier: dataset

  - type: class
    identifier: event_with_related
  - type: class
    identifier: organization_with_related
  - type: class
    identifier: opening_hours_specification_with_related
  - type: class
    identifier: image_with_related
  - type: class
    identifier: public_service_with_related

  - type: content
    identifier: Contatti-URP
    condition: $is_install_from_scratch
  - type: content
    identifier: Palazzo-del-municipio
    condition: $is_install_from_scratch
  - type: content
    identifier: Ufficio-relazioni-con-il-pubblico
    condition: $is_install_from_scratch
  - type: content
    identifier: Consiglio-comunale
    condition: $is_install_from_scratch
  - type: content
    identifier: Giunta-comunale
    condition: $is_install_from_scratch
  - type: content
    identifier: Commissione
    condition: $is_install_from_scratch
  - type: content
    identifier: PNRR-la-digitalizzazione-dei-servizi-comunali
    condition: $is_install_from_scratch
  - type: content
    identifier: Con-il-nuovo-sito-web-il-comune-e-sempre-piu-digitale
    condition: $is_install_from_scratch
  - type: content
    identifier: Kit-comuni
    condition: $is_install_from_scratch
  - type: content
    identifier: Opencityitalia
  - type: content
    identifier: Architettura-e-contenuti

  - type: class_with_extra
    identifier: homepage
  - type: content
    identifier: OpenCity
    swap_with: $root_node
    remove_swapped: true
    lock: $do_lock
    reset:
      - page
      - link_al_menu_orizzontale
      - link_nel_footer

  - type: role
    identifier: Anonymous
    apply_to:
      - $anonymous_user
      - $members
  - type: role
    identifier: Members
    apply_to:
      - $members
      - $content_Editor-Base_object
  - type: role
    identifier: Editor-Base
    apply_to:
      - $content_Editor-Base_object
  - type: role
    identifier: Editor-Amministrazione
    apply_to:
      - $content_Editor-Amministrazione_object
  - type: role
    identifier: Editor-Classificazioni
    apply_to:
      - $content_Editor-Base_object
  - type: role
    identifier: Editor-Vivere-il-comune
    apply_to:
      - $content_Editor-Vivere-il-comune_object
  - type: role
    identifier: Editor-Novita
    apply_to:
      - $content_Editor-Novita_object
  - type: role
    identifier: Editor-Servizi
    apply_to:
      - $content_Editor-Servizi_object
  - type: role
    identifier: Editor-Utenti
    apply_to:
      - $content_Editor-Utenti_object
  - type: role
    identifier: Editor-Sito
    apply_to:
      - $content_Editor-Sito_object
  - type: role
    identifier: Editor-Backend
  - type: role
    identifier: Dashboard-Luoghi
    apply_to:
      - $content_Editor-Vivere-il-comune_object
  - type: role
    identifier: Editor-Homepage
    apply_to:
      - $content_Editor-Homepage_object

  - type: openparecaptcha
    public: $recaptcha_public
    private: $recaptcha_private
    condition: $is_install_from_scratch
  - type: openparecaptcha_v3
    public: $recaptcha_v3_public
    private: $recaptcha_v3_private
    condition: $is_install_from_scratch

  - type: workflow
    identifier: Post-pubblicazione
    trigger:
      module: content
      function: publish
      connection_type: after
  - type: workflow
    identifier: Pre-pubblicazione
    trigger:
      module: content
      function: publish
      connection_type: before

  - type: change_state
    identifier: default
  - type: change_section
    identifier: default

  - type: rename
    condition: $is_install_from_scratch

  - type: class
    identifier: faq_root
  - type: class_with_extra
    identifier: faq_section
  - type: class_with_extra
    identifier: faq_group
  - type: class_with_extra
    identifier: faq
  - type: content
    identifier: FAQ
  - type: contenttree
    identifier: FAQs
    parent: $content_FAQ_node
  - type: content
    identifier: Editor-Faq
  - type: role
    identifier: Editor-Faq
    apply_to:
      - $content_Editor-Faq_object

  - type: php_callable
    identifier: 'BootstrapItaliaInstallerUtils::setGovernmentServiceOntologyMap'

  - type: class
    identifier: edit_homepage
    condition: $do_lock

  - type: class
    identifier: edit_page
    condition: $do_lock

  - type: role
    identifier: Partner